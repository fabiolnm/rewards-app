name: Deploy to AWS ECS

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ECS Fargate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push web image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd web
          docker build \
            -t ${{ secrets.ECR_WEB_REPOSITORY }}:$IMAGE_TAG \
            -t ${{ secrets.ECR_WEB_REPOSITORY }}:latest \
            .
          docker push ${{ secrets.ECR_WEB_REPOSITORY }}:$IMAGE_TAG
          docker push ${{ secrets.ECR_WEB_REPOSITORY }}:latest

      - name: Build and push API image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd api
          docker build \
            -t ${{ secrets.ECR_API_REPOSITORY }}:$IMAGE_TAG \
            -t ${{ secrets.ECR_API_REPOSITORY }}:latest \
            .
          docker push ${{ secrets.ECR_API_REPOSITORY }}:$IMAGE_TAG
          docker push ${{ secrets.ECR_API_REPOSITORY }}:latest

      - name: Run database migrations
        run: |
          echo "Running database migrations as one-off Fargate task..."

          # Get the VPC and subnet configuration from the API service
          SERVICE_CONFIG=$(aws ecs describe-services \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --services ${{ secrets.ECS_API_SERVICE }} \
            --query 'services[0].networkConfiguration.awsvpcConfiguration')

          SUBNETS=$(echo $SERVICE_CONFIG | jq -r '.subnets | join(",")')
          SECURITY_GROUPS=$(echo $SERVICE_CONFIG | jq -r '.securityGroups | join(",")')

          # Run migrations task
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --task-definition ${{ secrets.ECS_API_TASK_DEFINITION }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SECURITY_GROUPS],assignPublicIp=ENABLED}" \
            --overrides '{
              "containerOverrides": [{
                "name": "api",
                "command": ["bundle", "exec", "ruby", "bin/run-migrations"]
              }]
            }' \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Migration task ARN: $TASK_ARN"

          # Wait for task to complete
          echo "Waiting for migrations to complete..."
          aws ecs wait tasks-stopped \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --tasks $TASK_ARN

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --tasks $TASK_ARN \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "‚ùå Migrations failed with exit code: $EXIT_CODE"
            exit 1
          fi

          echo "‚úÖ Migrations completed successfully"

      - name: Update web service
        run: |
          echo "Updating web service..."
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --service ${{ secrets.ECS_WEB_SERVICE }} \
            --force-new-deployment

      - name: Update API service
        run: |
          echo "Updating API service..."
          aws ecs update-service \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --service ${{ secrets.ECS_API_SERVICE }} \
            --force-new-deployment

      - name: Wait for services to stabilize
        run: |
          echo "Waiting for web service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --services ${{ secrets.ECS_WEB_SERVICE }}

          echo "Waiting for API service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --services ${{ secrets.ECS_API_SERVICE }}

          echo "‚úÖ Deployment complete!"

      - name: Get service URLs
        run: |
          echo "Fetching service public IPs..."

          # Get web task public IP
          WEB_TASK_ARN=$(aws ecs list-tasks \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --service-name ${{ secrets.ECS_WEB_SERVICE }} \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)

          if [ "$WEB_TASK_ARN" != "None" ]; then
            WEB_ENI=$(aws ecs describe-tasks \
              --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
              --tasks $WEB_TASK_ARN \
              --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
              --output text)

            WEB_IP=$(aws ec2 describe-network-interfaces \
              --network-interface-ids $WEB_ENI \
              --query 'NetworkInterfaces[0].Association.PublicIp' \
              --output text)

            echo "üåê Web URL: http://$WEB_IP"
          fi

          # Get API task public IP
          API_TASK_ARN=$(aws ecs list-tasks \
            --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
            --service-name ${{ secrets.ECS_API_SERVICE }} \
            --desired-status RUNNING \
            --query 'taskArns[0]' \
            --output text)

          if [ "$API_TASK_ARN" != "None" ]; then
            API_ENI=$(aws ecs describe-tasks \
              --cluster ${{ secrets.ECS_CLUSTER_NAME }} \
              --tasks $API_TASK_ARN \
              --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
              --output text)

            API_IP=$(aws ec2 describe-network-interfaces \
              --network-interface-ids $API_ENI \
              --query 'NetworkInterfaces[0].Association.PublicIp' \
              --output text)

            echo "üöÄ API URL: http://$API_IP:3000"
          fi

          echo ""
          echo "Note: IPs may change on service restarts. Use ECS console for current IPs."
